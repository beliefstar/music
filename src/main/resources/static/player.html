<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NavMusic</title>
    <!-- Bootstrap CSS -->
    <link href="./lib/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome 图标 -->
    <link rel="stylesheet" href="./lib/font-awesome.min.css">
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --lyric-active-color: #0d6efd;
            --lyric-color: #666;
        }

        body {
            min-height: 100vh;
        }

        .player-container {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            width: 100%;
            margin: 20px auto;
            padding-top: 15px;
        }

        .player-content {
            display: flex;
            height: 100%;
        }

        .left-panel {
            flex: 2;
            padding: 20px;
            /*border-right: 1px solid #e9ecef;*/
        }

        .right-panel {
            flex: 3;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .download-button {
            position: absolute;
            right: 30px;
            top: 30px;
            z-index: 0;
        }

        .album-art-container {
            position: relative;
            overflow: hidden;
            margin: 20px auto;
            box-shadow: 0 0 15px rgba(50, 50, 50, 0.2);
            width: 200px;
            height: 200px;
            border-radius: 50%;
        }

        .album-art {
            position: absolute;
            top: 0;
            left: 0;
            width: 90%;
            height: 90%;
            object-fit: contain;
            transform-origin: 90px 100px;
        }

        .song-info {
            text-align: center;
            margin: 30px 0;
            padding: 0 15px;
        }

        .song-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--dark-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .song-artist {
            font-size: 1rem;
            color: var(--secondary-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .progress-container {
            width: 100%;
            height: 6px;
            background-color: #e9ecef;
            border-radius: 3px;
            cursor: pointer;
            margin: 20px 0;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s linear;
        }

        .time-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--secondary-color);
            margin-bottom: 20px;
            padding: 0 15px;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 15px;
        }

        .control-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: var(--secondary-color);
            cursor: pointer;
            margin: 0 10px;
            outline: none;
            transition: all 0.2s;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .control-btn:hover {
            color: var(--primary-color);
            background-color: rgba(13, 110, 253, 0.1);
        }

        .play-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 10px rgba(13, 110, 253, 0.3);
            margin: 0 15px;
        }

        .play-btn:hover {
            background-color: #0b5ed7;
            color: white;
            transform: scale(1.05);
        }

        .volume-container {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 0 15px;
        }

        .volume-icon {
            margin-right: 10px;
            color: var(--secondary-color);
            width: 20px;
            text-align: center;
        }

        .volume-slider {
            flex-grow: 1;
            height: 5px;
            -webkit-appearance: none;
            background: #e9ecef;
            border-radius: 5px;
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 15px;
            height: 15px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
        }

        .play-mode-container {
            display: flex;
            justify-content: center;
            margin-bottom: 15px;
            padding: 0 15px;
        }

        .play-mode-btn {
            background: none;
            border: none;
            color: var(--secondary-color);
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
            margin: 0 10px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .play-mode-btn:hover, .play-mode-btn.active {
            color: var(--primary-color);
            background-color: rgba(13, 110, 253, 0.1);
        }

        .play-mode-btn.active {
            font-weight: bold;
        }

        /* 歌词区域样式 */
        .lyrics-container {
            flex: 1;
            overflow: hidden;
            position: relative;
            margin-top: 20px;
        }

        .lyrics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }

        .lyrics-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--dark-color);
        }

        .lyrics-status {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 10px;
            background-color: #e9ecef;
        }

        .lyrics-status.loading {
            color: #0d6efd;
            background-color: rgba(13, 110, 253, 0.1);
        }

        .lyrics-status.loaded {
            color: #198754;
            background-color: rgba(25, 135, 84, 0.1);
        }

        .lyrics-status.error {
            color: #dc3545;
            background-color: rgba(220, 53, 69, 0.1);
        }

        .lyrics-wrapper {
            height: 300px;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 10px;
            border-radius: 8px;
            /*background-color: #f8f9fa;*/
        }

        .lyrics-content {
            font-size: 1.1rem;
            line-height: 2;
            text-align: center;
            transition: all 0.3s ease;
        }

        .lyric-line {
            padding: 8px 0;
            opacity: 0.6;
            transition: all 0.3s ease;
            cursor: default;
        }

        .lyric-line.active {
            opacity: 1;
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--lyric-active-color);
            transform: scale(1.05);
        }

        .lyric-line.empty {
            height: 2.5em;
        }

        .no-lyrics {
            text-align: center;
            color: var(--secondary-color);
            padding: 50px 20px;
            font-style: italic;
        }

        .playlist-container {
            max-height: 80vh;
            overflow-y: auto;
            margin-top: 20px;
            border-top: 1px solid #e9ecef;
            padding: 15px;
        }

        .playlist-item {
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .playlist-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .playlist-item.active {
            background-color: rgba(13, 110, 253, 0.1);
            color: var(--primary-color);
        }

        .playlist-item img {
            width: 40px;
            height: 40px;
            border-radius: 5px;
            margin-right: 15px;
            object-fit: cover;
        }

        .playlist-item i {
            font-size: 24px;
            margin-right: 15px;
            color: var(--secondary-color);
        }

        .playlist-item-info {
            flex-grow: 1;
            min-width: 0;
        }

        .playlist-item-title {
            font-weight: 500;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .playlist-item-artist {
            font-size: 0.8rem;
            color: var(--secondary-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @media (max-width: 768px) {
            .album-art-container {
                width: 200px;
                height: 200px;
            }
            .album-art {
                transform-origin: 82px 88px;
            }
        }

        @media (max-width: 576px) {
            .player-container {
                background-color: white;
                border-radius: 15px;
                box-shadow: 0 0 0;
                overflow: hidden;
                width: 100%;
                margin: 20px auto;
            }
        }

        /* 动画效果 */
        @keyframes rotateAlbumArt {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .rotate {
            animation: rotateAlbumArt 20s linear infinite;
        }

        .paused {
            animation-play-state: paused;
        }

        /* 歌词滚动条样式 */
        .lyrics-wrapper::-webkit-scrollbar {
            width: 5px;
        }

        .lyrics-wrapper::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 5px;
        }

        .lyrics-wrapper::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 5px;
        }

        .lyrics-wrapper::-webkit-scrollbar-thumb:hover {
            background: #aaa;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="row">
        <div class="col-12" style="padding: 0">
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <a class="navbar-brand" href="/index.html">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-music-note-list" viewBox="0 0 16 16">
                        <path d="M12 13c0 1.105-1.12 2-2.5 2S7 14.105 7 13s1.12-2 2.5-2 2.5.895 2.5 2z"/>
                        <path fill-rule="evenodd" d="M12 3v10h-1V3h1z"/>
                        <path d="M11 2.82a1 1 0 0 1 .804-.98l3-.6A1 1 0 0 1 16 2.22V4l-5 1V2.82z"/>
                        <path fill-rule="evenodd" d="M0 11.5a.5.5 0 0 1 .5-.5H4a.5.5 0 0 1 0 1H.5a.5.5 0 0 1-.5-.5zm0-4A.5.5 0 0 1 .5 7H8a.5.5 0 0 1 0 1H.5a.5.5 0 0 1-.5-.5zm0-4A.5.5 0 0 1 .5 3H8a.5.5 0 0 1 0 1H.5a.5.5 0 0 1-.5-.5z"/>
                    </svg>
                    NavMusic
                </a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse justify-content-end" id="navbarSupportedContent">
                    <form class="form-inline my-2 my-lg-0" id="search-form" method="get" action="/search.html">
                        <input name="keyword" class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
                        <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
                    </form>
                </div>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="player-container">
                <button type="button" class="btn btn-info btn-sm download-button" id="downloadBtn" >下载</button>

                <div class="player-content">
                    <div class="left-panel">
                        <div class="album-art-container">
                            <img id="albumArt" class="album-art" src="./img/nav_logo.png" alt="封面">
                        </div>
                    </div>

                    <div class="right-panel">
                        <div class="lyrics-container">
                            <div class="lyrics-header" style="display: none;">
                                <div class="lyrics-title">歌词</div>
                                <div id="lyricsStatus" class="lyrics-status">未加载</div>
                            </div>
                            <div class="lyrics-wrapper" id="lyricsWrapper">
                                <div class="lyrics-content" id="lyricsContent">
                                    <div class="no-lyrics">暂无歌词，请播放歌曲</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="song-info">
                    <h3 id="songTitle" class="song-title">歌曲名称</h3>
                    <p id="songArtist" class="song-artist">艺术家</p>
                </div>

                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar" id="progressBar"></div>
                </div>

                <div class="time-info">
                    <span id="currentTime">0:00</span>
                    <span id="duration">0:00</span>
                </div>

                <div class="controls">
                    <button class="control-btn" id="prevBtn" title="上一首"><i class="fas fa-step-backward"></i></button>
                    <button class="control-btn play-btn" id="playBtn" title="播放/暂停"><i class="fas fa-play"></i></button>
                    <button class="control-btn" id="nextBtn" title="下一首"><i class="fas fa-step-forward"></i></button>
                </div>

                <div class="play-mode-container">
                    <button class="play-mode-btn" id="orderModeBtn" title="顺序播放"><i class="fas fa-list-ol"></i></button>
                    <button class="play-mode-btn" id="loopModeBtn" title="单曲循环"><i class="fas fa-redo"></i></button>
                    <button class="play-mode-btn active" id="randomModeBtn" title="随机播放"><i class="fas fa-random"></i></button>
                </div>

                <div class="volume-container">
                    <span class="volume-icon"><i class="fas fa-volume-up"></i></span>
                    <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.01" value="0.7">
                </div>

                <div class="playlist-container" id="playlistContainer">
                    <!-- 播放列表将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
    </div>
</div>

<audio id="audio"></audio>

<!-- Bootstrap JS Bundle with Popper -->
<script src="./lib/jquery-3.7.1.min.js"></script>
<script src="./lib/bootstrap.bundle.min.js"></script>
<script src="./cus/session.js"></script>

<script>
    // 播放模式常量
    const PLAY_MODE = {
        ORDER: 'order',     // 顺序播放
        LOOP: 'loop',       // 单曲循环
        RANDOM: 'random'    // 随机播放
    };

    // 歌词解析器
    class LyricParser {
        constructor(lyricText) {
            this.lyricText = lyricText || '';
            this.lines = [];
            this.times = [];
            this.parse();
        }

        parse() {
            if (!this.lyricText) {
                this.lines = [''];
                this.times = [0];
                return;
            }

            const lines = this.lyricText.split('\n');
            const timeRegex = /\[(\d{2}):(\d{2})(?:\.(\d{2,3}))?\]/g;

            for (let line of lines) {
                const matches = line.match(timeRegex);
                const text = line.replace(timeRegex, '').trim();

                if (matches && text) {
                    matches.forEach(match => {
                        const timeMatch = match.match(/\[(\d{2}):(\d{2})(?:\.(\d{2,3}))?\]/);
                        if (timeMatch) {
                            const minutes = parseInt(timeMatch[1]);
                            const seconds = parseInt(timeMatch[2]);
                            const milliseconds = timeMatch[3] ? parseInt(timeMatch[3].padEnd(3, '0')) : 0;
                            const time = minutes * 60 + seconds + milliseconds / 1000;

                            this.times.push(time);
                            this.lines.push(text);
                        }
                    });
                }
            }

            // 如果没有有效歌词，添加一个空行
            if (this.lines.length === 0) {
                this.lines = [''];
                this.times = [0];
            }
        }

        getLyricAtTime(currentTime) {
            if (this.times.length === 0) return { line: '', index: -1 };

            for (let i = this.times.length - 1; i >= 0; i--) {
                if (currentTime >= this.times[i]) {
                    return { line: this.lines[i], index: i };
                }
            }

            return { line: '', index: -1 };
        }

        getFormattedLyrics() {
            return this.lines.map((line, index) => ({
                time: this.times[index] || 0,
                text: line
            }));
        }
    }

    // 音乐播放器类
    class MusicPlayer {
        constructor(options = {}) {
            // 音频元素
            this.audio = document.getElementById('audio');

            // 播放器元素
            this.playBtn = document.getElementById('playBtn');
            this.prevBtn = document.getElementById('prevBtn');
            this.nextBtn = document.getElementById('nextBtn');
            this.progressBar = document.getElementById('progressBar');
            this.progressContainer = document.getElementById('progressContainer');
            this.currentTimeEl = document.getElementById('currentTime');
            this.durationEl = document.getElementById('duration');
            this.volumeSlider = document.getElementById('volumeSlider');
            this.songTitle = document.getElementById('songTitle');
            this.songArtist = document.getElementById('songArtist');
            this.albumArt = document.getElementById('albumArt');
            this.playlistContainer = document.getElementById('playlistContainer');
            this.downloadBtn = document.getElementById('downloadBtn');

            // 歌词元素
            this.lyricsContent = document.getElementById('lyricsContent');
            this.lyricsWrapper = document.getElementById('lyricsWrapper');
            this.lyricsStatus = document.getElementById('lyricsStatus');

            // 歌词相关
            this.lyricParser = null;
            this.currentLyricIndex = -1;
            this.lyricCache = new Map(); // 缓存歌词数据

            // 播放模式按钮
            this.orderModeBtn = document.getElementById('orderModeBtn');
            this.loopModeBtn = document.getElementById('loopModeBtn');
            this.randomModeBtn = document.getElementById('randomModeBtn');

            // 播放列表
            this.playlist = options.playlist || [];
            this.currentSongIndex = 0;
            this.playMode = PLAY_MODE.RANDOM; // 默认随机播放

            // 回调函数
            this.onPlay = options.onPlay || function() {};
            this.onPause = options.onPause || function() {};
            this.onPrev = options.onPrev || function() {};
            this.onNext = options.onNext || function() {};
            this.onTimeUpdate = options.onTimeUpdate || function() {};
            this.onSongChange = options.onSongChange || function() {};
            this.onEnded = options.onEnded || function() {};
            this.onModeChange = options.onModeChange || function() {};

            // 初始化
            this.init();
        }

        init() {
            // 设置初始音量
            this.audio.volume = this.volumeSlider.value;

            // 事件监听
            this.downloadBtn.addEventListener('click', () => this.downloadMusic());
            this.playBtn.addEventListener('click', () => this.togglePlay());
            this.prevBtn.addEventListener('click', () => this.prevSong());
            this.nextBtn.addEventListener('click', () => this.nextSong());
            this.progressContainer.addEventListener('click', (e) => this.setProgress(e));
            this.volumeSlider.addEventListener('input', () => this.setVolume());
            this.audio.addEventListener('timeupdate', () => this.updateProgress());
            this.audio.addEventListener('ended', () => this.songEnded());
            // this.audio.addEventListener('loadedmetadata', () => this.updateSongInfo());

            // 播放模式按钮事件
            this.orderModeBtn.addEventListener('click', () => this.setPlayMode(PLAY_MODE.ORDER));
            this.loopModeBtn.addEventListener('click', () => this.setPlayMode(PLAY_MODE.LOOP));
            this.randomModeBtn.addEventListener('click', () => this.setPlayMode(PLAY_MODE.RANDOM));

            // 触摸事件支持（移动端）
            this.progressContainer.addEventListener('touchstart', (e) => this.handleTouch(e));
            this.progressContainer.addEventListener('touchmove', (e) => this.handleTouch(e));

            // 加载第一首歌
            if (this.playlist.length > 0) {
                this.loadSong(this.currentSongIndex);
                this.renderPlaylist();
            }
        }

        // 处理触摸事件
        handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0] || e.changedTouches[0];
            const rect = this.progressContainer.getBoundingClientRect();
            const clickX = touch.clientX - rect.left;
            const duration = this.audio.duration;
            this.audio.currentTime = (clickX / rect.width) * duration;
        }

        // 加载歌曲
        loadSong(index) {
            if (index < 0 || index >= this.playlist.length) return;

            this.currentSongIndex = index;
            const song = this.playlist[index];
            this.audio.src = song.url;
            this.songTitle.textContent = song.title || '未知歌曲';
            this.songArtist.textContent = song.artist || '未知艺术家';
            this.albumArt.src = song.cover || './img/nav_logo.png';

            // 重置进度条
            this.progressBar.style.width = '0%';
            this.currentTimeEl.textContent = '0:00';

            // 更新播放列表中的活动项
            this.updateActivePlaylistItem();

            // 专辑封面旋转动画
            this.albumArt.classList.add('rotate');
            if (this.audio.paused) {
                this.albumArt.classList.add('paused');
            } else {
                this.albumArt.classList.remove('paused');
            }

            // 重置歌词状态
            this.resetLyrics();
            this.currentLyricIndex = -1;

            // 加载歌词
            this.loadLyrics(song);

            // 触发歌曲改变回调
            this.onSongChange(song, index);
        }

        // 重置歌词显示
        resetLyrics() {
            this.lyricsContent.innerHTML = '<div class="no-lyrics">加载歌词中...</div>';
            this.lyricsStatus.textContent = '加载中';
            this.lyricsStatus.className = 'lyrics-status loading';
        }

        // 获取歌词
        loadLyrics(song) {
            try {
                // 检查缓存
                if (this.lyricCache.has(song.id || song.title)) {
                    const cachedLyric = this.lyricCache.get(song.id || song.title);
                    this.updateLyricsDisplay(cachedLyric);
                    return;
                }

                // 模拟API调用 - 实际使用时替换为真实API
                loadMusicLyric(song.id, (data) => {
                    // 解析歌词
                    this.lyricParser = new LyricParser(data);

                    // 缓存歌词
                    this.lyricCache.set(song.id || song.title, this.lyricParser);

                    // 更新歌词显示
                    this.updateLyricsDisplay(this.lyricParser);
                });
            } catch(error) {
                console.error('获取歌词失败:', error);
                this.showLyricsError();
            }
        }

        // 更新歌词显示
        updateLyricsDisplay(lyricParser) {
            if (!lyricParser || lyricParser.lines.length === 0 || (lyricParser.lines.length === 1 && lyricParser.lines[0] === '')) {
                this.lyricsContent.innerHTML = '<div class="no-lyrics">暂无歌词</div>';
                this.lyricsStatus.textContent = '无歌词';
                this.lyricsStatus.className = 'lyrics-status';
                return;
            }

            const lyrics = lyricParser.getFormattedLyrics();
            let html = '';

            // 创建歌词行
            lyrics.forEach((lyric, index) => {
                html += `<div class="lyric-line" data-index="${index}" data-time="${lyric.time}">${lyric.text || '&nbsp;'}</div>`;
            });

            this.lyricsContent.innerHTML = html;
            this.lyricsStatus.textContent = '已加载';
            this.lyricsStatus.className = 'lyrics-status loaded';
        }

        // 显示歌词错误
        showLyricsError() {
            this.lyricsContent.innerHTML = '<div class="no-lyrics">歌词加载失败</div>';
            this.lyricsStatus.textContent = '加载失败';
            this.lyricsStatus.className = 'lyrics-status error';
        }

        // 更新当前播放的歌词
        updateCurrentLyric(currentTime) {
            if (!this.lyricParser) return;

            const { line, index } = this.lyricParser.getLyricAtTime(currentTime);

            // 如果歌词索引没有变化，不更新
            if (index === this.currentLyricIndex) return;

            this.currentLyricIndex = index;

            // 移除所有激活状态
            const lyricLines = this.lyricsContent.querySelectorAll('.lyric-line');
            lyricLines.forEach(lineEl => {
                lineEl.classList.remove('active');
            });

            // 激活当前歌词行
            if (index >= 0 && index < lyricLines.length) {
                const currentLine = lyricLines[index];
                currentLine.classList.add('active');

                // 滚动到当前歌词行
                this.scrollToLyric(currentLine);
            }
        }

        // 滚动到当前歌词行
        scrollToLyric(lyricElement) {
            if (!lyricElement) return;

            const wrapper = this.lyricsWrapper;
            const wrapperHeight = wrapper.clientHeight;
            const wrapperScrollTop = wrapper.scrollTop;
            const elementOffsetTop = lyricElement.offsetTop;
            const elementHeight = lyricElement.clientHeight;

            // 计算滚动位置
            const targetScrollTop = elementOffsetTop - (wrapperHeight / 2) + (elementHeight / 2);

            // 平滑滚动
            wrapper.scrollTo({
                top: targetScrollTop,
                behavior: 'smooth'
            });
        }

        // 播放/暂停切换
        togglePlay() {
            if (this.audio.paused) {
                this.audio.play();
                this.playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                this.albumArt.classList.remove('paused');
                this.onPlay(this.playlist[this.currentSongIndex], this.currentSongIndex);
            } else {
                this.audio.pause();
                this.playBtn.innerHTML = '<i class="fas fa-play"></i>';
                this.albumArt.classList.add('paused');
                this.onPause(this.playlist[this.currentSongIndex], this.currentSongIndex);
            }
        }

        // 上一首
        prevSong() {
            let newIndex;

            if (this.playMode === PLAY_MODE.RANDOM) {
                newIndex = this.getRandomIndex();
            } else {
                newIndex = this.currentSongIndex - 1;
                if (newIndex < 0) {
                    newIndex = this.playlist.length - 1;
                }
            }

            this.loadSong(newIndex);
            this.audio.play();
            this.playBtn.innerHTML = '<i class="fas fa-pause"></i>';
            this.albumArt.classList.remove('paused');

            // 触发上一首回调
            this.onPrev(this.playlist[this.currentSongIndex], this.currentSongIndex);
        }

        // 下一首
        nextSong() {
            let newIndex;

            if (this.playMode === PLAY_MODE.RANDOM) {
                newIndex = this.getRandomIndex();
            } else if (this.playMode === PLAY_MODE.LOOP) {
                newIndex = this.currentSongIndex; // 单曲循环，不改变索引
            } else {
                newIndex = this.currentSongIndex + 1;
                if (newIndex >= this.playlist.length) {
                    newIndex = 0;
                }
            }

            this.loadSong(newIndex);
            this.audio.play();
            this.playBtn.innerHTML = '<i class="fas fa-pause"></i>';
            this.albumArt.classList.remove('paused');

            // 触发下一首回调
            this.onNext(this.playlist[this.currentSongIndex], this.currentSongIndex);
        }

        // 更新进度条
        updateProgress() {
            const { currentTime, duration } = this.audio;
            const progressPercent = (currentTime / duration) * 100;
            this.progressBar.style.width = `${progressPercent}%`;

            // 更新时间显示
            this.currentTimeEl.textContent = this.formatTime(currentTime);
            this.durationEl.textContent = this.formatTime(duration);

            // 更新当前歌词
            this.updateCurrentLyric(currentTime);

            // 触发时间更新回调
            this.onTimeUpdate(currentTime, duration);
        }

        // 设置进度
        setProgress(e) {
            const width = this.progressContainer.clientWidth;
            const clickX = e.offsetX;
            const duration = this.audio.duration;
            this.audio.currentTime = (clickX / width) * duration;
        }

        // 设置音量
        setVolume() {
            this.audio.volume = this.volumeSlider.value;
            // 更新音量图标
            const volumeIcon = document.querySelector('.volume-icon i');
            if (this.audio.volume === 0) {
                volumeIcon.className = 'fas fa-volume-mute';
            } else if (this.audio.volume < 0.5) {
                volumeIcon.className = 'fas fa-volume-down';
            } else {
                volumeIcon.className = 'fas fa-volume-up';
            }
        }

        // 歌曲结束
        songEnded() {
            if (this.playMode === PLAY_MODE.LOOP) {
                this.audio.currentTime = 0;
                this.audio.play();
            } else {
                this.nextSong();
            }
            this.onEnded(this.playlist[this.currentSongIndex], this.currentSongIndex);
        }

        // 格式化时间
        formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';

            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
        }

        // 设置播放模式
        setPlayMode(mode) {
            this.playMode = mode;

            // 更新按钮状态
            this.orderModeBtn.classList.remove('active');
            this.loopModeBtn.classList.remove('active');
            this.randomModeBtn.classList.remove('active');

            switch (mode) {
                case PLAY_MODE.ORDER:
                    this.orderModeBtn.classList.add('active');
                    break;
                case PLAY_MODE.LOOP:
                    this.loopModeBtn.classList.add('active');
                    break;
                case PLAY_MODE.RANDOM:
                    this.randomModeBtn.classList.add('active');
                    break;
            }

            // 触发模式改变回调
            this.onModeChange(mode);
        }

        // 获取随机索引
        getRandomIndex() {
            if (this.playlist.length <= 1) return 0;

            let newIndex;
            do {
                newIndex = Math.floor(Math.random() * this.playlist.length);
            } while (newIndex === this.currentSongIndex);

            return newIndex;
        }

        // 添加歌曲到播放列表
        addToPlaylist(song) {
            this.playlist.push(song);
            if (this.playlist.length === 1) {
                this.loadSong(0);
            }
            this.renderPlaylist();
        }

        // 清空播放列表
        clearPlaylist() {
            this.playlist = [];
            this.currentSongIndex = 0;
            this.audio.src = '';
            this.songTitle.textContent = '歌曲名称';
            this.songArtist.textContent = '艺术家';
            this.albumArt.src = 'https://via.placeholder.com/250';
            this.progressBar.style.width = '0%';
            this.currentTimeEl.textContent = '0:00';
            this.durationEl.textContent = '0:00';
            this.playBtn.innerHTML = '<i class="fas fa-play"></i>';
            this.albumArt.classList.remove('rotate');
            this.renderPlaylist();
        }

        // 渲染播放列表
        renderPlaylist() {
            this.playlistContainer.innerHTML = '';

            this.playlist.forEach((song, index) => {
                const item = document.createElement('div');
                item.className = `playlist-item ${index === this.currentSongIndex ? 'active' : ''}`;
                let ctx = "";
                if (song.cover) {
                    ctx = `<img src="${song.cover}" alt="${song.title}">`
                } else {
                    ctx = '<i class="fa-solid fa-headphones"></i>'
                }
                item.innerHTML = `
                        ${ctx}
                        <div class="playlist-item-info">
                            <div class="playlist-item-title">${song.title || '未知歌曲'}</div>
                            <div class="playlist-item-artist">${song.artist || '未知艺术家'}</div>
                        </div>
                    `;

                item.addEventListener('click', () => {
                    this.loadSong(index);
                    if (this.audio.paused) {
                        this.togglePlay();
                    }
                });

                this.playlistContainer.appendChild(item);
            });
        }

        // 更新播放列表中的活动项
        updateActivePlaylistItem() {
            const items = this.playlistContainer.querySelectorAll('.playlist-item');
            items.forEach((item, index) => {
                if (index === this.currentSongIndex) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        downloadMusic() {
            let it = this.playlist[this.currentSongIndex];
            const link = document.createElement('a');
            link.href = it.url;
            link.download = `${it.artist}-${it.title}`;
            document.body.appendChild(link);
            link.click();

            document.body.removeChild(link);
        }
    }


    // 初始化播放器
    function initPlayer(data) {
        window.player = new MusicPlayer({
            playlist: data,
            onPlay: (song, index) => {
                console.log('播放:', song.title, '索引:', index);
            },
            onPause: (song, index) => {
                console.log('暂停:', song.title, '索引:', index);
            },
            onPrev: (song, index) => {
                console.log('上一首:', song.title, '索引:', index);
            },
            onNext: (song, index) => {
                console.log('下一首:', song.title, '索引:', index);
            },
            onTimeUpdate: (currentTime, duration) => {
                // console.log('时间更新:', currentTime, '/', duration);
            },
            onSongChange: (song, index) => {
                console.log('歌曲改变:', song.title, '索引:', index);
            },
            onEnded: (song, index) => {
                console.log('歌曲结束:', song.title, '索引:', index);
            },
            onModeChange: (mode) => {
                console.log('播放模式改变:', mode);
            }
        });
    }
    function buildUrl(id) {
        return "api/music/resource/" + id + "?nav-token=" + NavToken
    }
    function findIdx(reqId) {
        for (let i = 0; i < window.MusicList.length; i++) {
            let it = window.MusicList[i]
            if (it.id === reqId) {
                return i
            }
        }
        return -1
    }

    function loadMusicLyric(id, cb) {
        $.ajax({
            url: "api/v2/lyric?musicId=" + id,
            success(data) {
                cb(data)
            }
        })
    }

    function loadMusicList() {
        $.ajax({
            url: "api/music/list",
            success(data) {
                window.MusicList = data

                let list = []
                for (const i in data) {
                    let item = data[i]
                    list.push({
                        title: item['name'],
                        artist: item['artist'],
                        id: item['id'],
                        url: buildUrl(item['id']),
                    })
                }
                console.log(list)
                initPlayer(list)

                if (window.RequestPlayId !== '') {
                    let idx = findIdx(window.RequestPlayId)
                    if (idx >= 0) {
                        window.player.loadSong(findIdx(window.RequestPlayId))
                    }
                }
            }
        })
    }


    let params = new URLSearchParams(location.search)

    params.forEach((v, k) => {
        if (k === 'id') {
            window.RequestPlayId = v
        }
    })

    loadMusicList();
</script>
</body>
</html>